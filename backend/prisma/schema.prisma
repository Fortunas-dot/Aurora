// Prisma schema for TherapyAI database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - Authentication and base user info
model User {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String    @map("password_hash")
  encryptionKeyHash String    @map("encryption_key_hash")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  profile  UserProfile?
  sessions Session[]
  insights Insight[]

  @@map("users")
}

// User Profile - Long-term emotional profile (JSON-based)
model UserProfile {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")

  // Core identity and patterns (stored as JSON)
  coreValues                Json     @default("[]") @map("core_values")
  emotionalPatterns         Json     @default("[]") @map("emotional_patterns")
  currentGoals              Json     @default("[]") @map("current_goals")
  personalityTraits         Json     @default("{}") @map("personality_traits")
  communicationPreferences  Json     @default("{}") @map("communication_preferences")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

// Session - Individual therapy sessions
model Session {
  id                  String    @id @default(uuid())
  userId              String    @map("user_id")
  startedAt           DateTime  @default(now()) @map("started_at")
  endedAt             DateTime? @map("ended_at")
  status              String    @default("active") // active, completed, abandoned
  sessionSummary      String?   @map("session_summary") @db.Text
  emotionalTrajectory Json?     @map("emotional_trajectory")
  keyThemes           Json      @default("[]") @map("key_themes")
  durationSeconds     Int?      @map("duration_seconds")

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]
  insights Insight[]

  @@index([userId])
  @@index([status])
  @@map("sessions")
}

// Insight - Structured memory objects extracted from sessions
model Insight {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  sessionId        String   @map("session_id")

  type             String   // breakthrough, pattern, goal, value
  category         String   // emotional, behavioral, cognitive
  content          String   @db.Text
  emotionalContext Json?    @map("emotional_context")
  importanceScore  Int      @default(5) @map("importance_score") // 1-10
  tags             Json     @default("[]")

  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([importanceScore])
  @@map("insights")
}

// Message - Encrypted conversation data (30-day retention)
model Message {
  id               String   @id @default(uuid())
  sessionId        String   @map("session_id")
  role             String   // user, assistant
  contentEncrypted String   @map("content_encrypted") @db.Text
  iv               String   // Initialization vector for encryption
  authTag          String   @map("auth_tag") // Authentication tag for GCM
  emotionalMarkers Json?    @map("emotional_markers")
  timestamp        DateTime @default(now())

  // Relations
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([timestamp])
  @@map("messages")
}
